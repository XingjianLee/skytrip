# 🔍 数据库连接问题排查指南

## 问题现象

网站中的各个表都显示为空，但数据库中实际有数据。

## 可能的原因

### 1. 后端服务未启动（最常见）

**症状**：
- 前端页面可以打开，但所有数据都显示为空
- 浏览器控制台（F12）可能显示网络错误
- 无法访问 http://localhost:8000/docs

**解决方案**：
```powershell
# 启动后端服务
.\start_backend.ps1
# 或
.\start_backend.bat
```

### 2. 数据库连接配置错误

**症状**：
- 后端启动时显示数据库连接错误
- 日志中显示 "Can't connect to MySQL server"

**检查步骤**：
```powershell
# 1. 验证环境配置
python verify_env.py

# 2. 检查数据库服务是否运行
Get-Service -Name MySQL*

# 3. 测试数据库连接
python -c "from app.database import engine; engine.connect(); print('连接成功')"
```

**解决方案**：
- 确保 MySQL 服务正在运行
- 检查 `.env` 文件中的 `DATABASE_URL` 配置
- 如果密码包含特殊字符，确保已进行 URL 编码

### 3. 数据库中没有数据

**检查步骤**：
```powershell
# 查看数据库中的数据统计
python verify_data.py
```

**解决方案**：
```powershell
# 如果数据为空，运行初始化脚本
python init_database.py
```

### 4. 前端 API 配置错误

**症状**：
- 后端正常运行，但前端无法获取数据
- 浏览器控制台显示 CORS 错误或 404 错误

**检查步骤**：
1. 检查 `admin-frontend/.env` 文件：
   ```env
   VITE_API_BASE=http://localhost:8000
   ```
2. 检查浏览器控制台（F12）的网络请求
3. 确认前端是否使用了正确的 API 地址

**解决方案**：
- 创建或更新 `admin-frontend/.env` 文件
- 重启前端服务

## 快速诊断

运行诊断脚本：

```powershell
python check_services.py
```

这个脚本会检查：
- ✅ 数据库连接状态
- ✅ 后端服务运行状态
- ✅ 前端服务运行状态

## 完整启动流程

### 步骤 1：检查数据库

```powershell
# 检查数据库连接
python verify_env.py

# 检查数据库数据
python verify_data.py
```

### 步骤 2：启动后端服务

```powershell
# 方式一：使用脚本
.\start_backend.ps1

# 方式二：手动启动
.\venv\Scripts\Activate.ps1
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

**验证后端**：
- 打开浏览器访问：http://localhost:8000/docs
- 应该看到 Swagger API 文档页面

### 步骤 3：启动前端服务

```powershell
# 方式一：使用脚本
.\start_frontend.ps1

# 方式二：手动启动
cd admin-frontend
npm run dev
```

**验证前端**：
- 打开浏览器访问：http://localhost:5173
- 应该看到登录页面

### 步骤 4：登录并测试

1. 使用管理员账号登录
2. 检查各个页面是否能正常显示数据
3. 如果数据仍为空，检查浏览器控制台（F12）的错误信息

## 常见错误信息

### 错误 1：Connection refused

```
ConnectionRefusedError: [WinError 10061] 由于目标计算机积极拒绝，无法连接
```

**原因**：后端服务未启动

**解决**：启动后端服务

### 错误 2：Failed to fetch

```
Failed to fetch
Network Error
```

**原因**：
- 后端服务未启动
- 前端 API 配置错误
- CORS 问题

**解决**：
1. 确认后端服务正在运行
2. 检查 `admin-frontend/.env` 配置
3. 检查后端 CORS 设置

### 错误 3：401 Unauthorized

```
401 Unauthorized
```

**原因**：未登录或 Token 过期

**解决**：重新登录

### 错误 4：404 Not Found

```
404 Not Found
```

**原因**：API 路径错误或后端路由未注册

**解决**：
1. 检查 API 路径是否正确
2. 检查后端路由注册

## 验证数据是否正常

### 方法 1：使用诊断脚本

```powershell
python check_services.py
```

### 方法 2：直接测试 API

```powershell
# 测试后端 API（需要后端运行）
python -c "import requests; r = requests.get('http://localhost:8000/api/v1/flights/'); print(r.json()[:2] if r.status_code == 200 else r.text)"
```

### 方法 3：查看数据库

```powershell
# 查看数据统计
python verify_data.py
```

## 完整检查清单

在启动系统前，请确认：

- [ ] MySQL 服务正在运行
- [ ] 数据库 `skytrip` 已创建
- [ ] `.env` 文件已正确配置
- [ ] 数据库中有数据（运行 `python verify_data.py` 检查）
- [ ] 后端服务已启动（端口 8000）
- [ ] 前端服务已启动（端口 5173）
- [ ] 浏览器可以访问 http://localhost:8000/docs
- [ ] 浏览器可以访问 http://localhost:5173

## 一键启动（推荐）

使用一键启动脚本：

```powershell
.\start_all.bat
# 或
.\start_all.ps1
```

选择选项 3，系统会自动启动后端和前端服务。

## 获取帮助

如果问题仍未解决：

1. 运行诊断脚本：`python check_services.py`
2. 查看后端日志（启动后端服务的窗口）
3. 查看浏览器控制台（F12）
4. 检查 `docs/RUN_PROJECT.md` 了解详细启动步骤

